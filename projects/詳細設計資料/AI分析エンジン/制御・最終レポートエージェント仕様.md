# 制御・最終レポートエージェント 仕様書（最新版）

この仕様書は、AI分析エンジンの「制御・最終レポートエージェント（オーケストレータ）」の詳細仕様を示します。エージェントは「全体性能の確認・差分分析エージェント」「個別データ分析エージェント」を統括し、実行順序・入出力連携・失敗時リトライ・要約・最終レポート生成を担います。

---

## 目次
1. システム概要  
2. 処理の流れ  
3. 入力と出力  
4. 主要コンポーネント  
5. 機能の詳細  
6. システムの動かし方  
7. サンプルコード  
8. 初心者向け解説  
9. まとめ  
10. 開発ロードマップ

---

## 1. システム概要

### 1.1 目的
複数エージェントの実行を統括し、結果を統合して Notebook と HTML の最終レポートを生成します。各ステップの例外処理、再試行、並列化、優先度付け、成果物管理を一元化します。

### 1.2 役割
- 実行順序の管理（性能→個別の順で実行、個別は並列化）
- 入出力の連携（成果物の受け渡し、メタ情報の付帯）
- 失敗時リトライとフォールバック（上限回数、バックオフ）
- 要約と優先度付け（課題の重み計算）
- Notebook と HTML の最終レポート生成

---

## 2. 処理の流れ

### 2.1 高レベルフロー
```mermaid
sequenceDiagram
    participant O as オーケストレータ
    participant P as 性能差分
    participant I as 個別分析

    O->>P: データセットと設定を渡す
    P-->>O: 集計メトリクスと図表と差分
    O->>I: 個別タスクリストと参照文脈を渡す（並列）
    I-->>O: 個票の分析結果と可視化
    O->>O: サマリ統合と優先度付け
    O-->>O: Notebook と HTML を生成
```

### 2.2 詳細ステップ
1. 設定の読み込み（実行モード、並列度、リトライ設定、しきい値）
2. 性能差分エージェントを実行し、集計 JSON と図表を取得
3. 個別分析エージェントに「課題タスクリスト」を配布（並列スケジューリング）
4. 成果物を収集・正規化し、優先度を計算
5. Notebook と HTML のテンプレートへ埋め込み、最終レポートを出力

---

## 3. 入力と出力

### 3.1 入力
- データ: 評価結果の CSV/DB、メタ情報（被験者、日時、環境）
- ベースライン: 過去の集計 JSON やランID
- 設定: 並列度、最大リトライ回数、優先度重み、しきい値、テンプレートパス
- 参照: 仕様書、ソースコード、期待値（RAG 用）

### 3.2 出力
- 最終レポート: `reports/analysis_report_YYYYMMDD_HHMMSS.ipynb` と `reports/analysis_report_YYYYMMDD_HHMMSS.html`
- 図表: `reports/charts/` 配下（時系列、混同行列、ROC、PR、誤差ヒートマップ など）
- データ: `reports/data/analysis_summary.json` `reports/data/improvement_suggestions.json`
- ログ: 実行ログ、失敗リトライ履歴、各エージェントの出力要約

---

## 4. 主要コンポーネント
- orchestrator.py: 実行順序・並列スケジューリング・リトライ・成果物統合
- final_report.py: Notebook と HTML の最終生成
- scheduler: 並列実行とジョブ監視
- retry_manager: 失敗時の再試行、バックオフ制御
- artifact_registry: 図表・JSON の参照管理
- templates/: Notebook と HTML のテンプレート

---

## 5. 機能の詳細

### 5.1 並列スケジューリング
- 個別分析のタスクをフレームまたはケース単位で分割し、並列度上限を尊重して配布
- 失敗タスクは指数バックオフで再試行（例: 3回）

### 5.2 優先度付け
- 重み付きスコア: 影響範囲、発生頻度、差分量、再現性、重要カテゴリ
- ランキング上位から改善提案に反映

### 5.3 成果物統合
- 性能差分のトレンドと個別事例を関連付け（例: クラス単位の回帰と具体例）
- Notebook セルと HTML セクションに自動整形して配置

### 5.4 レポート生成
- Notebook: nbformat でセル構築、図表埋め込み、サマリと ToDo を出力
- HTML: Jinja2 テンプレートでチャートと表を組み込み

---

## 6. システムの動かし方
1. 設定ファイルを準備（並列度、しきい値、テンプレート）
2. オーケストレータを起動し、データパスとベースラインを指定
3. 完了後、`reports/` 配下の Notebook/HTML を確認

---

## 7. サンプルコード
```python
from ai_analysis_engine import Orchestrator

orchestrator = Orchestrator(
    parallelism=4,
    retry_max_attempts=3,
    baseline_path="reports/data/prev_summary.json",
    notebook_template="templates/notebook_template.ipynb",
    html_template="templates/html_template.html",
)

orchestrator.run(
    evaluation_data_path="datasets/eval.csv",
    spec_path="projects/spec.md",
    code_root="src/",
    output_dir="reports/",
)
```

---

## 8. 初心者向け解説
- まとめ役のエージェントです。まず全体の点検をしてから、個別の気になる箇所を詳しく調べ、最後にわかりやすいレポートにします。

---

## 9. まとめ
並列化・リトライ・成果物統合・最終レポート生成を一元化し、安定した運用と再現性の高い出力を保証します。

---

## 10. 開発ロードマップ
1. 並列スケジューラとリトライ基盤
2. 成果物レジストリと参照整合性チェック
3. Notebook と HTML のテンプレート整備
4. 優先度スコアリングのチューニング
5. CI での自動生成テスト


